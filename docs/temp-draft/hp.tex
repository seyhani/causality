\section{Finding Root Causes for Unsafe Behavior}

\subsection{Minimal Enabling as a Cause}

\begin{thm}\label{thm:hp-x-y}
Given an event structure $\es$, a cause $X = S \vdash\,e$
where $(S, e) \in \vdash$, and an effect $Y = S_f$
where $S_f \in \conf{\es}$, $X$ is a cause of $Y$
(according to the HP definition) iff there is at least one path
from $m_{S,e}$ to $x_{S_f}$ in the causal graph of $\es$.
\end{thm}

\begin{proof}
We prove for both directions.

$\Leftarrow$: We check the conditions of HP causality for the given cause and effect.

\begin{itemize}
  \item \textbf{AC1:} Both the cause and effect hold in the factual scenario;
  therefore, this condition is satisfied.
\end{itemize}

For AC2.\{a,b\}, assume $(W, w, x')$ is the witness discussed by HP.

\begin{itemize}  
  \item \textbf{AC2.a:} The idea here is to restrict the causal graph
  such that the effect holds as long as the cause.
  
  Assume the path from cause to effect is as follows:
  \begin{equation}\label{eq:validating-path}
    m_{S,e} \rightarrow
    r_{S_1,S_2} \rightarrow
    x_{S_2} \rightarrow
    r_{S_2, S_3} \rightarrow
    \cdots \rightarrow
    r_{S_{k-1}, S_k} \rightarrow x_{S_k} = x_{S_f}
  \end{equation}

  We also define $W$ as:
  \[ \left( \In{r_{S_1, S_2}} \setminus \set{x_{S_1}, m_{S,e}} \right) \cup
    \left( \bigcup_{i=2}^k \In{x_{S_i}} \setminus \set{r_{S_{i-1}, S_i}} \right) \]
   
  The elements of $W$ are shown with dotted boxes in Fig. \ref{fig:witness}.
  All variables in $W$ are set to False ($w$ is an all-False valuation).
  $x'$ sets $r_{S,e}$ to False as well.
  
  \textbf{The choice of $W$ and validating path:}
  By defining $W$ as explained above, and setting it to all-False,
  the value for each vertex of the \textit{validating} path
  (as shown in Eq. \ref{eq:validating-path})
  can be determined by its predecessor. For $i \geq 2$, we have:
  \begin{equation}\label{eq:x-Si-restrict}
    (x_{S_i})_w = r_{S_{i-1}, S_i}
  \end{equation}
  
  By definition, each reason vertex consists of
  an \textit{enabling} and a \textit{configuration} component.
  We know the validating path is in the causal graph. Hence, for $i \geq 2$,
  the enabling component for $r_{S_i, S_{i+1}}$ is satisfied; so we have:
  \begin{equation}\label{eq:r-Si-Si+1-restrict}
    r_{S_i, S_{i+1}} = (r_{S_i, S_{i+1}})_w = x_{S_i} \wedge \text{True} = x_{S_i}
  \end{equation}
  
  For $r_{S_1,S_2}$, after setting $W$ to all-False, we have:
  \begin{equation}\label{eq:r-S1-S2-restrict}
    (r_{S_1,S_2})_w = \text{True} \wedge m_{S,e} = m_{S,e}
  \end{equation}
  
  \input{./fig/fig:witness}

  As shown in Eqs.
  \ref{eq:x-Si-restrict}, \ref{eq:r-Si-Si+1-restrict}, \ref{eq:r-S1-S2-restrict},
  Setting $m_{S,e}$ to False and $W$ to all-False will set all vertices
  in the validating path to False.

  With the witness described above, we can see that the effect $x_{S_f}$
  is also valuated as False; therefore, condition AC2.a is satisfied.
  
  
  \item \textbf{AC2.b:} After setting $m_{S,e}$ to True,
  while maintaining $W$ as all-False, $x_{S_f}$ is valuated to True again;
  this follows from the equations of the validating path when $W$ is set to all-False.
  The \textit{validating edges} for $x_{S_f}$ are shown with thick lines
  in Fig. \ref{fig:ac2.b}. Observe that, re-setting any variable $v \not\in W$
  does \textbf{not} \textit{invalidate} the specified path for $x_{S_f}$.

  \input{./fig/fig:ac2.b}

  \item \textbf{AC3:} As our cause is a singleton,
  this condition is also satisfied.
\end{itemize}

$\Rightarrow$: Assume there is no path from $m_{S,e}$ to $x_{S_f}$
in the causal graph. The vertices remaining after a W-projection will be
$m_{S,e}$, $x_{S_f}$, and all parent vertices of $x_{S_f}$ (unreachable from $m_{S,e}$).
Assume we have chosen $(W, w, x')$ such that AC2.a is satisfied
(i.e. $Y_{wx'} = \text{False}$).
As there is no path from $m_{S,e}$ to $x_{S,f}$, we have: $Y_{wx} = Y_{w} = \text{False}$.
Hence, AC2.b cannot be satified, for any arbitrary $W$, which contradicts our assumption
$m_{S,e} \propto x_{S_f}$.

\end{proof}

\begin{thm}\label{thm:hp-x-disj-Y}
Given an event structure $\es$, a cause $X = S \minen e$,
and an effect $Y = \bigvee_{f} S_{f}$
where $\forall f.\;S_f \in \conf{\es}$, $X$ is a cause of $Y$
(according to the HP definition) iff there exists $f$ such that
there is at least one path from $m_{S,e}$ to $x_{S_f}$
in the causal graph of $\es$.
\end{thm}

\begin{proof}
We prove for both directions.

$\Leftarrow$: Assume there is a path from $m_{S,e}$ to $x_{S_f}$ for some $f$.
Also assume $W$ is defined as in Thm. \ref{thm:hp-x-y}. For this problem,
we construct the new witness $W'$ as follows:
\[ W' = W \cup \left( \bigcup_{f' \neq f} x_{S_{f'}} \right) \]

$W'$ is set to all-False, as before.

With the new witness, AC2.\{a,b\} can be satisfied
for the new problem.

$\Rightarrow$: Using an argument similar to the proof for Thm. \ref{thm:hp-x-y},
we can show that if $x \propto y$, there is at least one path from $m_{S,e}$ to $x_{S_f}$ for some $f$.
\end{proof}

\begin{thm}\label{thm:hp-x-conj-Y}
Given an event structure $\es$, a cause $X = S \minen e$,
and an effect $Y = \bigwedge_{f} S_{f}$ where $\forall f.\;S_f \in \conf{\es}$,
$X$ is a cause of $Y$ (according to the HP definition)
iff there exists $f$ such that there is at least one path from $m_{S,e}$ to $x_{S_f}$
in the causal graph of $\es$.
\end{thm}

\begin{proof}
$\Leftarrow$: The set $W$ is selected just as done in Thm. \ref{thm:hp-x-disj-Y}.
For any $w \in W \cap Y$, we set $w$ to True.

$\Rightarrow$: Similar to Thms. \ref{thm:hp-x-y}, \ref{thm:hp-x-disj-Y}.
\end{proof}

% \subsection{False Minimal Enabling as a Cause}

% In the previous section, we showed how to check causality for
% true minimal enabling relations
% (i.e. $S \vdash e =$ True in the given event structure).
% Now we want to improve the existing causal graph
% to include false minimal enabling relations as well.

% Given event structure $\es = (E, \#, \vdash)$,
% For each $S \subseteq E$ and $e \in E$, we define vertex $r_{S,e}$.
% The value associated with this vertex will be as follows:

% \[ m_{S,e} =
%   \begin{cases}
%     \Min{S}{e}   & \text{if } S \vdash_{min} e \\
%     \text{False} & \text{otherwise}
%   \end{cases}
% \]

% Where $\Min{S}{e}$ is defined as follows:
% \[ \Min{S}{e} =
%   \bigwedge_{S' \subseteq E.\;(S' \subset S) \vee (S \subset S')}
%   \neg m_{S',e}
% \]

% Informally, if $S$ minimally enables $e$, no pure sub- or super-set of $S$
% minimally enables $e$.

\subsection{False Conflict as a Cause}

As we construct the configurations lattice for an event structure, we check for both
conflicts and enablings. The causal graph described before only contains the enabling
steps. We can refine the previous model to account for conflicts as well.

\subsubsection{Causal Graph}

We add new vertices $c_{e,e'}$ to the graph previously described, where
$c_{e,e'}$ shows the conflict between the events $e, e'$.
For any edge $x_S \rightarrow r_{S,S'}$, we remove this edge,
add the new vertex $r^{(c)}_{S,S'}$, and add edges $x_S \rightarrow r^{(c)}_{S,S'}$ and
$r^{(1)}_{S,S'} \rightarrow r_{S,S'}$. We also re-label all previous $r$-vertices to $r^{(m)}$-vertices.
For each vertex $r^{(c)}_{S,S'}$, we add edges $c_{f,e} \rightarrow r^{(c)}_{S,S'}$,
where $e = S' \setminus S$ and $f \in S$.

\subsubsection{Causal Model}

All $m$- and $x$-variables are defined exactly as before.
We only re-define $r$-variables, and define $c$-variables.

\begin{itemize}
  \item $r^{(c)}_{S,S'}$ ($S,S' \subseteq E$): We have:
  \[ r^{(c)}_{S,S'} = x_S \wedge
    \left( \bigwedge_{ c_{f,e} \in \In{ r^{(c)}_{S,S'} } } \neg c_{f,e} \right) \]
  
  Informally, a reason variable $r^{(c)}_{S,S'}$ checks the conflict part for
  the induction step for obtaining configuration $S'$ from $S$.
  \item $r^{(c)}_{S,S'}$ ($S,S' \subseteq E$): We have:
  \[ r^{(m)}_{S,S'} = r^{(c)}_{S,S'} \wedge
    \left( \bigvee_{ m_{S,e} \in \In{ r^{(m)}_{S,S'} } } m_{S,e} \right) \]
  
  Informally, a reason variable $r^{(m)}_{S,S'}$ checks the enabling part for
  the induction step for obtaining configuration $S'$ from $S$.
  \item $c_{e,f}$ ($e,f \in E$): These variables hold the constant value of True.
  To avoid duplication, we only define one $c$-variable (and $c$-vertex) for a given pair $e,f$.
\end{itemize}

\subsubsection{Causality}

With the refined causal model, we can easily show
Thms. \ref{thm:hp-x-y}, \ref{thm:hp-x-disj-Y}, \ref{thm:hp-x-conj-Y} hold
when cause is a false conflict instead of a true minimal enabling relation.

% \begin{thm}\label{thm:hp:c:x-y}

% \end{thm}